<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SnapShot ‚Äî Reaction Game | BrainSmacks</title>
<meta name="description" content="Test your reflexes in SnapShot ‚Äî a 10-level reaction clicking game. How fast can you hit?">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<meta name="theme-color" content="#0e0e12">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0e0e12; --bg2: #1a1a24; --bg3: #22222e;
  --ink: #f0f0f0; --muted: #888; --border: rgba(255,255,255,0.08);
  --accent: #7c3aed; --accent-light: #a78bfa;
  --green: #4ade80; --red: #ef4444; --gold: #ffd700;
  --yellow: #facc15;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--ink); font-family: 'Space Grotesk', system-ui, sans-serif; min-height: 100vh; overflow-x: hidden; }
a { color: inherit; text-decoration: none; }

/* Home button */
.home-btn { position: fixed; top: 10px; left: 10px; z-index: 9999; padding: 6px 12px; border-radius: 20px; font-size: 14px; background: rgba(14,14,18,0.8); backdrop-filter: blur(8px); border: 1px solid var(--border); opacity: 0.7; transition: opacity 0.2s; }
.home-btn:hover { opacity: 1; }

/* Screens */
.screen { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center; }
.screen.active { display: flex; }
.title { font-size: clamp(36px, 8vw, 64px); font-weight: 700; background: linear-gradient(135deg, var(--accent-light), var(--green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.subtitle { color: var(--muted); font-size: 14px; letter-spacing: 2px; text-transform: uppercase; margin-top: 8px; }

/* Buttons */
.btn { padding: 14px 36px; border: none; border-radius: 12px; font-family: inherit; font-size: 16px; font-weight: 700; cursor: pointer; letter-spacing: 1px; text-transform: uppercase; transition: transform 0.15s, filter 0.15s, box-shadow 0.2s; }
.btn:hover { transform: scale(1.05); filter: brightness(1.1); }
.btn:active { transform: scale(0.98); }
.btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-light)); color: #fff; box-shadow: 0 4px 20px rgba(124,58,237,0.3); }
.btn-secondary { background: var(--bg2); color: var(--ink); border: 1px solid var(--border); }
.btn-danger { background: linear-gradient(135deg, #dc2626, var(--red)); color: #fff; }

/* Personal best */
.pb-display { margin-top: 16px; font-size: 13px; color: var(--muted); }
.pb-display span { color: var(--gold); font-weight: 700; }

/* Level intro */
.level-num { font-size: 80px; font-weight: 700; color: var(--accent-light); opacity: 0.3; }
.level-name { font-size: 32px; font-weight: 700; margin: 8px 0; }
.level-desc { color: var(--muted); font-size: 14px; max-width: 400px; line-height: 1.6; margin-bottom: 24px; }
.level-mechanic { display: inline-block; padding: 4px 14px; background: rgba(124,58,237,0.15); border: 1px solid rgba(124,58,237,0.3); border-radius: 20px; font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent-light); margin-bottom: 16px; }

/* HUD */
.hud { position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: rgba(14,14,18,0.95); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border); padding: 8px 16px; }
.hud-row { display: flex; justify-content: space-between; align-items: center; max-width: 840px; margin: 0 auto; gap: 12px; flex-wrap: wrap; }
.hud-item { font-size: 12px; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); }
.hud-item span { color: var(--ink); font-weight: 700; font-size: 14px; }
.hud-score span { color: var(--accent-light); font-size: 18px; }

/* Health bar */
.health-wrap { max-width: 840px; margin: 6px auto 0; height: 8px; background: var(--bg3); border-radius: 4px; overflow: hidden; position: relative; }
.health-bar { height: 100%; border-radius: 4px; transition: width 0.4s ease, background-color 0.4s ease; background: var(--green); }
.health-text { position: absolute; right: 8px; top: -1px; font-size: 9px; font-weight: 700; color: var(--ink); line-height: 10px; }

/* Combo */
.combo-display { position: fixed; top: 70px; right: 20px; z-index: 101; font-size: 28px; font-weight: 700; color: var(--accent-light); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
.combo-display.active { opacity: 1; }
.combo-display.pulse { animation: comboPulse 0.3s ease; }
@keyframes comboPulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
.combo-broken { position: fixed; top: 110px; right: 20px; z-index: 101; font-size: 12px; color: var(--red); letter-spacing: 2px; text-transform: uppercase; opacity: 0; pointer-events: none; }
.combo-broken.show { animation: brokenFade 1s ease forwards; }
@keyframes brokenFade { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-10px); } }

/* Game area */
.game-wrap { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 80px 16px 16px; }
.game-area { position: relative; width: 100%; max-width: 800px; height: 500px; background: var(--bg2); border: 1px solid var(--border); border-radius: 16px; cursor: crosshair; overflow: hidden; user-select: none; -webkit-user-select: none; }

/* Progress bar */
.progress-wrap { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background: rgba(255,255,255,0.05); }
.progress-bar { height: 100%; background: var(--accent); transition: width 0.3s ease; border-radius: 0 2px 0 0; }

/* Targets */
.target { position: absolute; border-radius: 50%; cursor: pointer; transform: scale(0); animation: targetPop 0.15s ease forwards; z-index: 10; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: rgba(0,0,0,0.5); }
.target.good { background: radial-gradient(circle at 35% 35%, #6ee7a0, var(--green)); box-shadow: 0 0 20px rgba(74,222,128,0.3); }
.target.decoy { background: radial-gradient(circle at 35% 35%, #f87171, var(--red)); box-shadow: 0 0 20px rgba(239,68,68,0.3); }
.target.ghost { opacity: 0; }
.target.ghost-hint { box-shadow: 0 0 30px rgba(124,58,237,0.4); border: 2px dashed rgba(124,58,237,0.3); background: transparent; }
.target.shrinking { animation: targetPop 0.15s ease forwards; }
@keyframes targetPop { 0% { transform: scale(0); } 70% { transform: scale(1.15); } 100% { transform: scale(1); } }

/* Hit effect */
.hit-burst { position: absolute; border-radius: 50%; pointer-events: none; z-index: 20; animation: burst 0.4s ease forwards; border: 3px solid var(--green); }
@keyframes burst { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }

/* Particles */
.particle { position: absolute; width: 6px; height: 6px; border-radius: 50%; pointer-events: none; z-index: 20; }

/* Miss X */
.miss-x { position: absolute; font-size: 32px; font-weight: 700; color: var(--red); pointer-events: none; z-index: 20; animation: missAnim 0.6s ease forwards; }
@keyframes missAnim { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

/* Score popup */
.score-popup { position: absolute; pointer-events: none; z-index: 25; font-weight: 700; font-size: 16px; text-shadow: 0 2px 8px rgba(0,0,0,0.5); animation: popupFloat 0.8s ease forwards; white-space: nowrap; }
@keyframes popupFloat { 0% { transform: translateY(0) scale(0.8); opacity: 1; } 100% { transform: translateY(-50px) scale(1); opacity: 0; } }

/* Screen flash */
.flash { position: absolute; inset: 0; pointer-events: none; z-index: 30; border-radius: 16px; animation: flashAnim 0.2s ease; }
.flash.red { background: rgba(239,68,68,0.15); }
.flash.green { background: rgba(74,222,128,0.08); }
@keyframes flashAnim { 0% { opacity: 1; } 100% { opacity: 0; } }

/* Screen shake */
.shake { animation: shake 0.3s ease; }
@keyframes shake { 0%,100% { transform: translateX(0); } 20%,60% { transform: translateX(-4px); } 40%,80% { transform: translateX(4px); } }

/* Level complete */
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; text-align: left; }
.stat-item { background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px; }
.stat-label { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); }
.stat-value { font-size: 22px; font-weight: 700; margin-top: 2px; }
.stars { font-size: 32px; margin: 12px 0; }

/* Rank */
.rank-letter { font-size: 120px; font-weight: 700; line-height: 1; }
.rank-s { color: var(--gold); text-shadow: 0 0 40px rgba(255,215,0,0.5), 0 0 80px rgba(255,215,0,0.3); }
.rank-a { color: var(--green); text-shadow: 0 0 40px rgba(74,222,128,0.4); }
.rank-b { color: var(--accent-light); text-shadow: 0 0 40px rgba(167,139,250,0.4); }
.rank-c { color: var(--yellow); text-shadow: 0 0 30px rgba(250,204,21,0.3); }
.rank-d { color: var(--muted); }
.rank-f { color: var(--red); text-shadow: 0 0 30px rgba(239,68,68,0.3); }
.new-record { color: var(--gold); font-size: 18px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; animation: recordPulse 0.6s ease infinite alternate; margin: 8px 0; }
@keyframes recordPulse { 0% { opacity: 0.7; transform: scale(1); } 100% { opacity: 1; transform: scale(1.05); } }

/* Animated counter */
.final-score { font-size: 48px; font-weight: 700; color: var(--accent-light); margin: 8px 0; }

/* Responsive */
@media (max-width: 768px) {
  .game-area { height: 400px; }
  .hud-row { gap: 8px; }
  .hud-item { font-size: 10px; }
  .hud-item span { font-size: 12px; }
  .combo-display { font-size: 22px; top: 65px; right: 12px; }
  .stats-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
  .rank-letter { font-size: 80px; }
}
@media (max-width: 480px) {
  .game-area { height: 350px; border-radius: 10px; }
  .title { font-size: 32px; }
  .level-num { font-size: 50px; }
  .level-name { font-size: 24px; }
  .btn { padding: 12px 28px; font-size: 14px; }
  .stat-value { font-size: 18px; }
  .final-score { font-size: 36px; }
  .hud { padding: 6px 10px; }
  .health-wrap { height: 6px; }
  .combo-display { font-size: 18px; }
}
@media (hover: none) and (pointer: coarse) {
  .target { min-width: 44px; min-height: 44px; }
  .btn { min-height: 48px; }
}
</style>
</head>
<body>
<a href="../" class="home-btn">üè† Home</a>

<!-- TITLE SCREEN -->
<div class="screen active" id="title-screen">
  <div class="title">SnapShot</div>
  <div class="subtitle">Reaction Game ¬∑ 10 Levels</div>
  <div style="margin-top:32px">
    <button class="btn btn-primary" onclick="Game.start()">üéØ START</button>
  </div>
  <div class="pb-display" id="pb-title">Personal Best: <span id="pb-value">‚Äî</span></div>
</div>

<!-- LEVEL INTRO SCREEN -->
<div class="screen" id="intro-screen">
  <div class="level-num" id="intro-num"></div>
  <div class="level-mechanic" id="intro-mechanic"></div>
  <div class="level-name" id="intro-name"></div>
  <div class="level-desc" id="intro-desc"></div>
  <button class="btn btn-primary" onclick="Game.startLevel()">READY</button>
</div>

<!-- GAME SCREEN -->
<div id="game-screen" class="screen">
  <div class="hud" id="hud">
    <div class="hud-row">
      <div class="hud-item" id="hud-level">Level: <span>1</span></div>
      <div class="hud-item hud-score">Score: <span id="hud-score">0</span></div>
      <div class="hud-item">Accuracy: <span id="hud-acc">100%</span></div>
    </div>
    <div class="health-wrap">
      <div class="health-bar" id="health-bar" style="width:100%"></div>
      <div class="health-text" id="health-text">100%</div>
    </div>
  </div>
  <div class="combo-display" id="combo-display">x1</div>
  <div class="combo-broken" id="combo-broken">COMBO BROKEN</div>
  <div class="game-wrap">
    <div class="game-area" id="game-area">
      <div class="progress-wrap"><div class="progress-bar" id="progress-bar"></div></div>
    </div>
  </div>
</div>

<!-- LEVEL COMPLETE SCREEN -->
<div class="screen" id="complete-screen">
  <div class="level-name" id="comp-title"></div>
  <div class="stars" id="comp-stars"></div>
  <div class="stats-grid" id="comp-stats"></div>
  <div style="display:flex;gap:12px;margin-top:8px">
    <button class="btn btn-primary" onclick="Game.nextLevel()">NEXT LEVEL ‚Üí</button>
  </div>
</div>

<!-- GAME OVER SCREEN -->
<div class="screen" id="gameover-screen">
  <div style="font-size:24px;font-weight:700;color:var(--red);margin-bottom:8px">GAME OVER</div>
  <div class="rank-letter" id="go-rank"></div>
  <div class="final-score" id="go-score"></div>
  <div id="go-record" style="display:none" class="new-record">‚òÖ NEW RECORD! ‚òÖ</div>
  <div class="stats-grid" id="go-stats"></div>
  <div style="display:flex;gap:12px;margin-top:8px">
    <button class="btn btn-danger" onclick="Game.start()">RETRY</button>
    <button class="btn btn-secondary" onclick="Game.showTitle()">HOME</button>
  </div>
</div>

<!-- VICTORY SCREEN -->
<div class="screen" id="victory-screen">
  <div style="font-size:24px;font-weight:700;color:var(--gold);margin-bottom:4px">üèÜ VICTORY üèÜ</div>
  <div class="rank-letter" id="vic-rank"></div>
  <div class="final-score" id="vic-score"></div>
  <div id="vic-record" style="display:none" class="new-record">‚òÖ NEW RECORD! ‚òÖ</div>
  <div class="stats-grid" id="vic-stats"></div>
  <div style="display:flex;gap:12px;margin-top:8px">
    <button class="btn btn-primary" onclick="Game.start()">PLAY AGAIN</button>
    <button class="btn btn-secondary" onclick="Game.showTitle()">HOME</button>
  </div>
</div>

<script>

var Game = (() => {
  // ===== LEVELS =====
  const LEVELS = [
    { name:'Warm Up', mechanic:'Basics', desc:'Click the green targets before they vanish. Get a feel for it.',
      targets:8, spawnMs:1400, lifeMs:2200, size:[55,65], speed:0, decoys:false, shrink:false, ghost:false, chain:false },
    { name:'Quick Draw', mechanic:'Speed', desc:'Targets disappear faster now. Stay sharp.',
      targets:10, spawnMs:1100, lifeMs:1600, size:[50,60], speed:0, decoys:false, shrink:false, ghost:false, chain:false },
    { name:'Sharpshooter', mechanic:'Precision', desc:'Smaller targets. Precision over panic.',
      targets:12, spawnMs:1200, lifeMs:1800, size:[32,42], speed:0, decoys:false, shrink:false, ghost:false, chain:false },
    { name:'Moving Targets', mechanic:'Tracking', desc:'Targets drift around. Track and click.',
      targets:10, spawnMs:1300, lifeMs:2200, size:[45,55], speed:1.5, decoys:false, shrink:false, ghost:false, chain:false },
    { name:'Friend or Foe', mechanic:'Judgement', desc:'Red decoys appear! Clicking one costs you dearly.',
      targets:12, spawnMs:1000, lifeMs:2000, size:[45,55], speed:0.8, decoys:true, decoyRate:0.3, shrink:false, ghost:false, chain:false },
    { name:'Shrinking', mechanic:'Timing', desc:'Targets shrink over time. Hit them before they vanish.',
      targets:12, spawnMs:1100, lifeMs:2400, size:[55,65], speed:0.5, decoys:false, shrink:true, ghost:false, chain:false },
    { name:'Chaos', mechanic:'Overload', desc:'Fast, small, moving. Everything at once.',
      targets:15, spawnMs:800, lifeMs:1400, size:[30,40], speed:2, decoys:true, decoyRate:0.25, shrink:true, ghost:false, chain:false },
    { name:'Ghost', mechanic:'Perception', desc:'Targets fade in and out. Watch for the shimmer.',
      targets:12, spawnMs:1200, lifeMs:2600, size:[45,55], speed:1, decoys:true, decoyRate:0.2, shrink:false, ghost:true, chain:false },
    { name:'Chain Reaction', mechanic:'Combos', desc:'Rapid fire targets. Keep your combo alive for massive points.',
      targets:20, spawnMs:600, lifeMs:1200, size:[38,48], speed:1.2, decoys:false, shrink:false, ghost:false, chain:true },
    { name:'Boss Round', mechanic:'Everything', desc:'All mechanics combined. Survive and prove yourself.',
      targets:20, spawnMs:700, lifeMs:1500, size:[28,42], speed:2.2, decoys:true, decoyRate:0.3, shrink:true, ghost:true, chain:true },
  ];

  // ===== STATE =====
  let level = 0, score = 0, combo = 0, maxCombo = 0, health = 100;
  let hits = 0, misses = 0, decoyHits = 0, misclicks = 0;
  let targetsSpawned = 0, targetsTotal = 0;
  let spawnTimer = null, activeTargets = [], moveRAF = null;
  let levelStartTime = 0, totalReactionMs = 0, reactionCount = 0;
  let bestScores = []; // per-level
  let personalBest = parseInt(localStorage.getItem('snapshot_pb')) || 0;

  // ===== DOM =====
  const $ = id => document.getElementById(id);
  const area = () => $('game-area');
  const screens = ['title-screen','intro-screen','game-screen','complete-screen','gameover-screen','victory-screen'];

  function showScreen(id) {
    screens.forEach(s => {
      const el = $(s);
      el.classList.toggle('active', s === id);
    });
  }

  // ===== PERSONAL BEST =====
  function updatePB() {
    const el = $('pb-value');
    if (personalBest > 0) el.textContent = personalBest.toLocaleString();
    else el.textContent = '‚Äî';
  }

  // ===== TITLE =====
  function showTitle() {
    updatePB();
    showScreen('title-screen');
  }

  // ===== START GAME =====
  function start() {
    level = 0; score = 0; health = 100;
    hits = 0; misses = 0; decoyHits = 0; misclicks = 0;
    bestScores = [];
    totalReactionMs = 0; reactionCount = 0;
    showIntro();
  }

  // ===== LEVEL INTRO =====
  function showIntro() {
    const L = LEVELS[level];
    $('intro-num').textContent = String(level + 1).padStart(2, '0');
    $('intro-mechanic').textContent = L.mechanic;
    $('intro-name').textContent = L.name;
    $('intro-desc').textContent = L.desc;
    showScreen('intro-screen');
  }

  // ===== START LEVEL =====
  function startLevel() {
    const L = LEVELS[level];
    combo = 0; maxCombo = 0;
    targetsSpawned = 0; targetsTotal = L.targets;
    activeTargets = [];

    // Update HUD
    $('hud-level').querySelector('span').textContent = level + 1;
    $('hud-score').textContent = score;
    updateHealth();
    updateAccuracy();
    $('progress-bar').style.width = '0%';
    $('combo-display').className = 'combo-display';
    $('combo-display').textContent = '';
    area().innerHTML = '<div class="progress-wrap"><div class="progress-bar" id="progress-bar"></div></div>';

    showScreen('game-screen');
    levelStartTime = performance.now();

    // Spawn first target immediately
    spawnTarget(L);

    // Spawn loop
    spawnTimer = setInterval(() => {
      if (targetsSpawned >= targetsTotal) {
        clearInterval(spawnTimer);
        spawnTimer = null;
        // wait for remaining targets to expire, then end level
        waitForClear();
        return;
      }
      spawnTarget(L);
    }, L.spawnMs);

    // Area click handler
    area().onmousedown = area().ontouchstart = (e) => {
      if (e.type === 'touchstart') e.preventDefault();
      const rect = area().getBoundingClientRect();
      const cx = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const cy = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

      // Check if hit a target
      let hitTarget = null;
      for (let i = activeTargets.length - 1; i >= 0; i--) {
        const t = activeTargets[i];
        const el = t.el;
        const tr = el.getBoundingClientRect();
        const tx = tr.left - rect.left + tr.width / 2;
        const ty = tr.top - rect.top + tr.height / 2;
        const dist = Math.hypot(cx - tx, cy - ty);
        if (dist <= tr.width / 2 + 5) {
          hitTarget = t;
          break;
        }
      }

      if (hitTarget) {
        handleTargetClick(hitTarget, cx, cy, L);
      } else {
        // Misclick on empty space
        misclicks++;
        health = Math.max(0, health - 5);
        breakCombo();
        showMissX(cx, cy);
        flashArea('red');
        updateHealth();
        if (health <= 0) endGame(false);
      }
    };

    // Start movement loop
    if (L.speed > 0) startMovement(L);
  }

  // ===== SPAWN TARGET =====
  function spawnTarget(L) {
    targetsSpawned++;
    $('progress-bar').style.width = (targetsSpawned / targetsTotal * 100) + '%';

    const isDecoy = L.decoys && Math.random() < (L.decoyRate || 0.25);
    const size = L.size[0] + Math.random() * (L.size[1] - L.size[0]);
    const areaRect = area().getBoundingClientRect();
    const maxX = areaRect.width - size - 10;
    const maxY = areaRect.height - size - 30;
    const x = 10 + Math.random() * maxX;
    const y = 10 + Math.random() * maxY;

    const el = document.createElement('div');
    el.className = 'target ' + (isDecoy ? 'decoy' : 'good');
    el.style.width = size + 'px';
    el.style.height = size + 'px';
    el.style.left = x + 'px';
    el.style.top = y + 'px';

    // Ghost mechanic
    if (L.ghost && !isDecoy) {
      el.classList.add('ghost');
      // Shimmer in and out
      let ghostPhase = 0;
      const ghostInterval = setInterval(() => {
        ghostPhase++;
        const vis = Math.sin(ghostPhase * 0.5) * 0.5 + 0.5;
        el.style.opacity = Math.max(0.05, vis * 0.9);
      }, 100);
      el._ghostInterval = ghostInterval;
    }

    // Shrink mechanic
    if (L.shrink && !isDecoy) {
      el.style.transition = `width ${L.lifeMs}ms linear, height ${L.lifeMs}ms linear`;
      requestAnimationFrame(() => {
        el.style.width = '8px';
        el.style.height = '8px';
      });
    }

    area().appendChild(el);

    const t = {
      el, isDecoy, size, x, y,
      vx: L.speed ? (Math.random() - 0.5) * L.speed * 2 : 0,
      vy: L.speed ? (Math.random() - 0.5) * L.speed * 2 : 0,
      spawnTime: performance.now()
    };
    activeTargets.push(t);

    // Auto-expire
    t.expireTimer = setTimeout(() => {
      removeTarget(t, true);
    }, L.lifeMs);
  }

  // ===== MOVEMENT =====
  function startMovement(L) {
    function frame() {
      const areaEl = area();
      const w = areaEl.clientWidth;
      const h = areaEl.clientHeight;
      activeTargets.forEach(t => {
        t.x += t.vx;
        t.y += t.vy;
        const s = t.el.getBoundingClientRect().width || t.size;
        if (t.x < 5) { t.x = 5; t.vx *= -1; }
        if (t.y < 5) { t.y = 5; t.vy *= -1; }
        if (t.x > w - s - 5) { t.x = w - s - 5; t.vx *= -1; }
        if (t.y > h - s - 25) { t.y = h - s - 25; t.vy *= -1; }
        t.el.style.left = t.x + 'px';
        t.el.style.top = t.y + 'px';
      });
      moveRAF = requestAnimationFrame(frame);
    }
    moveRAF = requestAnimationFrame(frame);
  }

  // ===== HANDLE TARGET CLICK =====
  function handleTargetClick(t, cx, cy, L) {
    if (t.isDecoy) {
      // Hit a decoy!
      decoyHits++;
      health = Math.max(0, health - 15);
      breakCombo();
      flashArea('red');
      showScorePopup(cx, cy, '-15%', 'var(--red)');
      area().classList.add('shake');
      setTimeout(() => area().classList.remove('shake'), 300);
    } else {
      // Good hit!
      hits++;
      const reactionMs = performance.now() - t.spawnTime;
      totalReactionMs += reactionMs;
      reactionCount++;

      combo++;
      if (combo > maxCombo) maxCombo = combo;
      updateCombo();

      // Precision scoring
      const { label, color, points } = getPrecision(reactionMs, L);
      const comboMult = Math.min(combo, 10);
      const gained = Math.round(points * (1 + (comboMult - 1) * 0.15));
      score += gained;
      $('hud-score').textContent = score;

      showHitBurst(cx, cy, color);
      spawnParticles(cx, cy, color);
      showScorePopup(cx, cy, `+${gained} ${label}`, color);
      if (combo >= 3) flashArea('green');
    }

    removeTarget(t, false);
    updateHealth();
    updateAccuracy();
    if (health <= 0) endGame(false);
  }

  // ===== PRECISION =====
  function getPrecision(ms, L) {
    const base = L.lifeMs;
    const ratio = ms / base;
    if (ratio < 0.2) return { label: 'PERFECT', color: 'var(--gold)', points: 150 };
    if (ratio < 0.35) return { label: 'GREAT', color: 'var(--green)', points: 120 };
    if (ratio < 0.55) return { label: 'GOOD', color: 'var(--accent-light)', points: 90 };
    if (ratio < 0.75) return { label: 'OK', color: 'var(--muted)', points: 60 };
    return { label: 'SLOW', color: 'var(--red)', points: 30 };
  }

  // ===== REMOVE TARGET =====
  function removeTarget(t, expired) {
    const idx = activeTargets.indexOf(t);
    if (idx === -1) return;
    activeTargets.splice(idx, 1);
    clearTimeout(t.expireTimer);
    if (t._ghostInterval) clearInterval(t._ghostInterval);
    if (t.el.parentNode) t.el.parentNode.removeChild(t.el);

    if (expired && !t.isDecoy) {
      misses++;
      health = Math.max(0, health - 8);
      breakCombo();
      updateHealth();
      updateAccuracy();
      if (health <= 0 && spawnTimer !== null) endGame(false);
    }
  }

  // ===== COMBO =====
  function updateCombo() {
    const cd = $('combo-display');
    if (combo >= 2) {
      cd.textContent = 'x' + Math.min(combo, 10);
      cd.classList.add('active');
      cd.classList.remove('pulse');
      void cd.offsetWidth;
      cd.classList.add('pulse');
    }
  }

  function breakCombo() {
    if (combo >= 3) {
      const cb = $('combo-broken');
      cb.classList.remove('show');
      void cb.offsetWidth;
      cb.classList.add('show');
    }
    combo = 0;
    const cd = $('combo-display');
    cd.classList.remove('active');
  }

  // ===== HEALTH =====
  function updateHealth() {
    const bar = $('health-bar');
    bar.style.width = health + '%';
    bar.style.backgroundColor = health > 50 ? 'var(--green)' : health > 25 ? 'var(--yellow)' : 'var(--red)';
    $('health-text').textContent = Math.round(health) + '%';
  }

  // ===== ACCURACY =====
  function updateAccuracy() {
    const total = hits + misses + decoyHits + misclicks;
    const acc = total === 0 ? 100 : Math.round((hits / total) * 100);
    $('hud-acc').textContent = acc + '%';
  }

  // ===== VISUAL EFFECTS =====
  function showHitBurst(x, y, color) {
    const el = document.createElement('div');
    el.className = 'hit-burst';
    el.style.left = (x - 20) + 'px';
    el.style.top = (y - 20) + 'px';
    el.style.width = '40px';
    el.style.height = '40px';
    el.style.borderColor = color;
    area().appendChild(el);
    setTimeout(() => el.remove(), 400);
  }

  function spawnParticles(x, y, color) {
    for (let i = 0; i < 6; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.left = x + 'px';
      p.style.top = y + 'px';
      p.style.backgroundColor = color;
      const angle = (Math.PI * 2 / 6) * i + Math.random() * 0.5;
      const dist = 30 + Math.random() * 40;
      const dx = Math.cos(angle) * dist;
      const dy = Math.sin(angle) * dist;
      p.style.transition = 'all 0.4s ease-out';
      area().appendChild(p);
      requestAnimationFrame(() => {
        p.style.transform = `translate(${dx}px, ${dy}px)`;
        p.style.opacity = '0';
      });
      setTimeout(() => p.remove(), 450);
    }
  }

  function showMissX(x, y) {
    const el = document.createElement('div');
    el.className = 'miss-x';
    el.textContent = '‚úï';
    el.style.left = (x - 12) + 'px';
    el.style.top = (y - 16) + 'px';
    area().appendChild(el);
    setTimeout(() => el.remove(), 600);
  }

  function showScorePopup(x, y, text, color) {
    const el = document.createElement('div');
    el.className = 'score-popup';
    el.textContent = text;
    el.style.left = x + 'px';
    el.style.top = (y - 10) + 'px';
    el.style.color = color;
    area().appendChild(el);
    setTimeout(() => el.remove(), 800);
  }

  function flashArea(type) {
    const el = document.createElement('div');
    el.className = 'flash ' + type;
    area().appendChild(el);
    setTimeout(() => el.remove(), 200);
  }

  // ===== WAIT FOR REMAINING TARGETS =====
  function waitForClear() {
    const check = setInterval(() => {
      if (activeTargets.length === 0 || health <= 0) {
        clearInterval(check);
        if (health <= 0) endGame(false);
        else endLevel();
      }
    }, 200);
  }

  // ===== END LEVEL =====
  function endLevel() {
    cleanup();
    const L = LEVELS[level];
    const total = hits + misses;
    const acc = total === 0 ? 100 : Math.round((hits / total) * 100);
    const avgReaction = reactionCount > 0 ? Math.round(totalReactionMs / reactionCount) : 0;
    const stars = acc >= 95 ? '‚≠ê‚≠ê‚≠ê' : acc >= 80 ? '‚≠ê‚≠ê' : acc >= 60 ? '‚≠ê' : 'üíÄ';

    $('comp-title').textContent = `Level ${level + 1}: ${L.name}`;
    $('comp-stars').textContent = stars;
    $('comp-stats').innerHTML = `
      <div class="stat-item"><div class="stat-label">Score</div><div class="stat-value" style="color:var(--accent-light)">${score.toLocaleString()}</div></div>
      <div class="stat-item"><div class="stat-label">Accuracy</div><div class="stat-value">${acc}%</div></div>
      <div class="stat-item"><div class="stat-label">Best Combo</div><div class="stat-value" style="color:var(--gold)">x${maxCombo}</div></div>
      <div class="stat-item"><div class="stat-label">Avg Reaction</div><div class="stat-value">${avgReaction}ms</div></div>
    `;

    if (level >= LEVELS.length - 1) {
      endGame(true);
    } else {
      showScreen('complete-screen');
    }
  }

  // ===== NEXT LEVEL =====
  function nextLevel() {
    level++;
    showIntro();
  }

  // ===== END GAME =====
  function endGame(victory) {
    cleanup();
    const total = hits + misses + decoyHits + misclicks;
    const acc = total === 0 ? 100 : Math.round((hits / total) * 100);
    const avgReaction = reactionCount > 0 ? Math.round(totalReactionMs / reactionCount) : 0;
    const rank = getRank(score, acc, level);
    const isRecord = score > personalBest;
    if (isRecord) {
      personalBest = score;
      localStorage.setItem('snapshot_pb', personalBest);
    }

    const prefix = victory ? 'vic' : 'go';
    const rankEl = $(prefix + '-rank');
    rankEl.textContent = rank;
    rankEl.className = 'rank-letter rank-' + rank.toLowerCase();
    $(prefix + '-score').textContent = score.toLocaleString();
    $(prefix + '-record').style.display = isRecord ? 'block' : 'none';

    const statsHTML = `
      <div class="stat-item"><div class="stat-label">Hits</div><div class="stat-value" style="color:var(--green)">${hits}</div></div>
      <div class="stat-item"><div class="stat-label">Misses</div><div class="stat-value" style="color:var(--red)">${misses}</div></div>
      <div class="stat-item"><div class="stat-label">Accuracy</div><div class="stat-value">${acc}%</div></div>
      <div class="stat-item"><div class="stat-label">Best Combo</div><div class="stat-value" style="color:var(--gold)">x${maxCombo}</div></div>
      <div class="stat-item"><div class="stat-label">Avg Reaction</div><div class="stat-value">${avgReaction}ms</div></div>
      <div class="stat-item"><div class="stat-label">Level Reached</div><div class="stat-value">${level + 1} / 10</div></div>
    `;
    $(prefix + '-stats').innerHTML = statsHTML;

    showScreen(victory ? 'victory-screen' : 'gameover-screen');
  }

  // ===== RANK =====
  function getRank(score, acc, level) {
    const s = score / 100 + acc * 0.3 + level * 5;
    if (s >= 70) return 'S';
    if (s >= 55) return 'A';
    if (s >= 40) return 'B';
    if (s >= 25) return 'C';
    if (s >= 15) return 'D';
    return 'F';
  }

  // ===== CLEANUP =====
  function cleanup() {
    if (spawnTimer) { clearInterval(spawnTimer); spawnTimer = null; }
    if (moveRAF) { cancelAnimationFrame(moveRAF); moveRAF = null; }
    activeTargets.forEach(t => {
      clearTimeout(t.expireTimer);
      if (t._ghostInterval) clearInterval(t._ghostInterval);
    });
    activeTargets = [];
    area().onmousedown = null;
    area().ontouchstart = null;
  }

  // ===== INIT =====
  updatePB();

  return { start, startLevel, nextLevel, showTitle };
})();
</script>
</body>
</html>
