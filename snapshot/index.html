<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SnapShot ‚Äî Reaction Game | BrainSmacks</title>
<meta name="description" content="Test your reflexes in SnapShot ‚Äî a 10-level reaction clicking game. How fast can you hit?">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<meta name="theme-color" content="#0e0e12">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0e0e12; --bg2: #1a1a24; --bg3: #22222e;
  --ink: #f0f0f0; --muted: #888; --border: rgba(255,255,255,0.08);
  --accent: #7c3aed; --accent-light: #a78bfa;
  --green: #4ade80; --red: #ef4444; --gold: #ffd700;
  --yellow: #facc15;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--ink); font-family: 'Space Grotesk', system-ui, sans-serif; min-height: 100vh; overflow-x: hidden; }
a { color: inherit; text-decoration: none; }

/* Home button */
.home-btn { position: fixed; top: 10px; left: 10px; z-index: 9999; padding: 6px 12px; border-radius: 20px; font-size: 14px; background: rgba(14,14,18,0.8); backdrop-filter: blur(8px); border: 1px solid var(--border); opacity: 0.7; transition: opacity 0.2s; }
.home-btn:hover { opacity: 1; }

/* Screens */
.screen { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center; }
.screen.active { display: flex; }
#game-screen.active { display: block; }
.title { font-size: clamp(36px, 8vw, 64px); font-weight: 700; background: linear-gradient(135deg, var(--accent-light), var(--green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.subtitle { color: var(--muted); font-size: 14px; letter-spacing: 2px; text-transform: uppercase; margin-top: 8px; }

/* Buttons */
.btn { padding: 14px 36px; border: none; border-radius: 12px; font-family: inherit; font-size: 16px; font-weight: 700; cursor: pointer; letter-spacing: 1px; text-transform: uppercase; transition: transform 0.15s, filter 0.15s, box-shadow 0.2s; }
.btn:hover { transform: scale(1.05); filter: brightness(1.1); }
.btn:active { transform: scale(0.98); }
.btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-light)); color: #fff; box-shadow: 0 4px 20px rgba(124,58,237,0.3); }
.btn-secondary { background: var(--bg2); color: var(--ink); border: 1px solid var(--border); }
.btn-danger { background: linear-gradient(135deg, #dc2626, var(--red)); color: #fff; }

/* Personal best */
.pb-display { margin-top: 16px; font-size: 13px; color: var(--muted); }
.pb-display span { color: var(--gold); font-weight: 700; }

/* Level intro */
.level-num { font-size: 80px; font-weight: 700; color: var(--accent-light); opacity: 0.3; }
.level-name { font-size: 32px; font-weight: 700; margin: 8px 0; }
.level-desc { color: var(--muted); font-size: 14px; max-width: 400px; line-height: 1.6; margin-bottom: 24px; }
.level-mechanic { display: inline-block; padding: 4px 14px; background: rgba(124,58,237,0.15); border: 1px solid rgba(124,58,237,0.3); border-radius: 20px; font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent-light); margin-bottom: 16px; }

/* HUD */
.hud { position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: rgba(14,14,18,0.95); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border); padding: 8px 16px; }
.hud-row { display: flex; justify-content: space-between; align-items: center; max-width: 840px; margin: 0 auto; gap: 12px; flex-wrap: wrap; }
.hud-item { font-size: 12px; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); }
.hud-item span { color: var(--ink); font-weight: 700; font-size: 14px; }
.hud-score span { color: var(--accent-light); font-size: 18px; }

/* Health bar */
.health-wrap { max-width: 840px; margin: 6px auto 0; height: 8px; background: var(--bg3); border-radius: 4px; overflow: hidden; position: relative; }
.health-bar { height: 100%; border-radius: 4px; transition: width 0.4s ease, background-color 0.4s ease; background: var(--green); }
.health-text { position: absolute; right: 8px; top: -1px; font-size: 9px; font-weight: 700; color: var(--ink); line-height: 10px; }

/* Combo */
.combo-display { position: fixed; top: 70px; right: 20px; z-index: 101; font-size: 28px; font-weight: 700; color: var(--accent-light); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
.combo-display.active { opacity: 1; }
.combo-display.pulse { animation: comboPulse 0.3s ease; }
@keyframes comboPulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
.combo-broken { position: fixed; top: 110px; right: 20px; z-index: 101; font-size: 12px; color: var(--red); letter-spacing: 2px; text-transform: uppercase; opacity: 0; pointer-events: none; }
.combo-broken.show { animation: brokenFade 1s ease forwards; }
@keyframes brokenFade { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-10px); } }

/* Game area */
.game-wrap { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 80px 16px 16px; }
.game-area { position: relative; width: 800px; max-width: calc(100vw - 32px); height: 500px; background: var(--bg2); border: 1px solid var(--border); border-radius: 16px; cursor: crosshair; overflow: hidden; user-select: none; -webkit-user-select: none; }
.game-area.scope-cursor { cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='12' fill='none' stroke='%23a78bfa' stroke-width='1.5' opacity='0.8'/%3E%3Ccircle cx='16' cy='16' r='2' fill='%23a78bfa' opacity='0.9'/%3E%3Cline x1='16' y1='0' x2='16' y2='10' stroke='%23a78bfa' stroke-width='1' opacity='0.6'/%3E%3Cline x1='16' y1='22' x2='16' y2='32' stroke='%23a78bfa' stroke-width='1' opacity='0.6'/%3E%3Cline x1='0' y1='16' x2='10' y2='16' stroke='%23a78bfa' stroke-width='1' opacity='0.6'/%3E%3Cline x1='22' y1='16' x2='32' y2='16' stroke='%23a78bfa' stroke-width='1' opacity='0.6'/%3E%3C/svg%3E") 16 16, crosshair; }

/* Progress bar */
.progress-wrap { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background: rgba(255,255,255,0.05); }
.progress-bar { height: 100%; background: var(--accent); transition: width 0.3s ease; border-radius: 0 2px 0 0; }

/* Targets */
.target { position: absolute; border-radius: 50%; cursor: pointer; transform: scale(0); animation: targetPop 0.15s ease forwards; z-index: 10; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: rgba(0,0,0,0.5); will-change: transform; }
.target.good { background: radial-gradient(circle at 35% 35%, #6ee7a0, var(--green)); box-shadow: 0 0 20px rgba(74,222,128,0.3); }
.target.decoy { background: radial-gradient(circle at 35% 35%, #f87171, var(--red)); box-shadow: 0 0 20px rgba(239,68,68,0.3); }
.target.ghost { opacity: 0; }
.target.ghost-hint { box-shadow: 0 0 30px rgba(124,58,237,0.4); border: 2px dashed rgba(124,58,237,0.3); background: transparent; }
.target.shrinking { animation: targetPop 0.15s ease forwards; }
@keyframes targetPop { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.15); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
.target.moving { animation: targetPopMoving 0.15s ease forwards; }
@keyframes targetPopMoving { 0% { opacity: 0; } 100% { opacity: 1; } }

/* Hit effect */
.hit-burst { position: absolute; border-radius: 50%; pointer-events: none; z-index: 20; animation: burst 0.4s ease forwards; border: 3px solid var(--green); }
@keyframes burst { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }

/* Particles */
.particle { position: absolute; width: 6px; height: 6px; border-radius: 50%; pointer-events: none; z-index: 20; will-change: transform, opacity; }

/* Miss X */
.miss-x { position: absolute; font-size: 32px; font-weight: 700; color: var(--red); pointer-events: none; z-index: 20; animation: missAnim 0.6s ease forwards; }
@keyframes missAnim { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

/* Score popup */
.score-popup { position: absolute; pointer-events: none; z-index: 25; font-weight: 700; font-size: 16px; text-shadow: 0 2px 8px rgba(0,0,0,0.5); animation: popupFloat 0.8s ease forwards; white-space: nowrap; }
@keyframes popupFloat { 0% { transform: translateY(0) scale(0.8); opacity: 1; } 100% { transform: translateY(-50px) scale(1); opacity: 0; } }

/* Screen flash */
.flash { position: absolute; inset: 0; pointer-events: none; z-index: 30; border-radius: 16px; animation: flashAnim 0.2s ease; }
.flash.red { background: rgba(239,68,68,0.15); }
.flash.green { background: rgba(74,222,128,0.08); }
@keyframes flashAnim { 0% { opacity: 1; } 100% { opacity: 0; } }

/* Screen shake */
.shake { animation: shake 0.3s ease; }
@keyframes shake { 0%,100% { transform: translateX(0); } 20%,60% { transform: translateX(-4px); } 40%,80% { transform: translateX(4px); } }

/* Level complete */
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; text-align: left; }
.stat-item { background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px; }
.stat-label { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); }
.stat-value { font-size: 22px; font-weight: 700; margin-top: 2px; }
.stars { font-size: 32px; margin: 12px 0; }

/* Rank */
.rank-letter { font-size: 120px; font-weight: 700; line-height: 1; }
.rank-s { color: var(--gold); text-shadow: 0 0 40px rgba(255,215,0,0.5), 0 0 80px rgba(255,215,0,0.3); }
.rank-a { color: var(--green); text-shadow: 0 0 40px rgba(74,222,128,0.4); }
.rank-b { color: var(--accent-light); text-shadow: 0 0 40px rgba(167,139,250,0.4); }
.rank-c { color: var(--yellow); text-shadow: 0 0 30px rgba(250,204,21,0.3); }
.rank-d { color: var(--muted); }
.rank-f { color: var(--red); text-shadow: 0 0 30px rgba(239,68,68,0.3); }
.new-record { color: var(--gold); font-size: 18px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; animation: recordPulse 0.6s ease infinite alternate; margin: 8px 0; }
@keyframes recordPulse { 0% { opacity: 0.7; transform: scale(1); } 100% { opacity: 1; transform: scale(1.05); } }

/* Animated counter */
.final-score { font-size: 48px; font-weight: 700; color: var(--accent-light); margin: 8px 0; }

/* Responsive */
@media (max-width: 768px) {
  .game-area { height: 400px; }
  .hud-row { gap: 8px; }
  .hud-item { font-size: 10px; }
  .hud-item span { font-size: 12px; }
  .combo-display { font-size: 22px; top: 65px; right: 12px; }
  .stats-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
  .rank-letter { font-size: 80px; }
}
@media (max-width: 480px) {
  .game-area { height: 350px; border-radius: 10px; }
  .title { font-size: 32px; }
  .level-num { font-size: 50px; }
  .level-name { font-size: 24px; }
  .btn { padding: 12px 28px; font-size: 14px; }
  .stat-value { font-size: 18px; }
  .final-score { font-size: 36px; }
  .hud { padding: 6px 10px; }
  .health-wrap { height: 6px; }
  .combo-display { font-size: 18px; }
}
@media (hover: none) and (pointer: coarse) {
  .target { min-width: 44px; min-height: 44px; }
  .btn { min-height: 48px; }
}
</style>
</head>
<body>
<a href="../" class="home-btn">üè† Home</a>

<!-- TITLE SCREEN -->
<div class="screen active" id="title-screen">
  <div class="title">SnapShot</div>
  <div class="subtitle">Reaction Game ¬∑ 10 Levels</div>
  <div style="margin-top:32px">
    <button class="btn btn-primary" onclick="Game.start()">üéØ START</button>
  </div>
  <div class="pb-display" id="pb-title">Personal Best: <span id="pb-value">‚Äî</span></div>
</div>

<!-- LEVEL INTRO SCREEN -->
<div class="screen" id="intro-screen">
  <div class="level-num" id="intro-num"></div>
  <div class="level-mechanic" id="intro-mechanic"></div>
  <div class="level-name" id="intro-name"></div>
  <div class="level-desc" id="intro-desc"></div>
  <button class="btn btn-primary" onclick="Game.startLevel()">READY</button>
</div>

<!-- GAME SCREEN -->
<div id="game-screen" class="screen">
  <div class="hud" id="hud">
    <div class="hud-row">
      <div class="hud-item" id="hud-level">Level: <span>1</span></div>
      <div class="hud-item hud-score">Score: <span id="hud-score">0</span></div>
      <div class="hud-item">Accuracy: <span id="hud-acc">100%</span></div>
    </div>
    <div class="health-wrap">
      <div class="health-bar" id="health-bar" style="width:100%"></div>
      <div class="health-text" id="health-text">100%</div>
    </div>
  </div>
  <div class="combo-display" id="combo-display">x1</div>
  <div class="combo-broken" id="combo-broken">COMBO BROKEN</div>
  <div class="game-wrap">
    <div class="game-area" id="game-area">
      <div class="progress-wrap"><div class="progress-bar" id="progress-bar"></div></div>
    </div>
  </div>
</div>

<!-- LEVEL COMPLETE SCREEN -->
<div class="screen" id="complete-screen">
  <div class="level-name" id="comp-title"></div>
  <div class="stars" id="comp-stars"></div>
  <div class="stats-grid" id="comp-stats"></div>
  <div style="display:flex;gap:12px;margin-top:8px">
    <button class="btn btn-primary" onclick="Game.nextLevel()">NEXT LEVEL ‚Üí</button>
  </div>
</div>

<!-- GAME OVER SCREEN -->
<div class="screen" id="gameover-screen">
  <div style="font-size:24px;font-weight:700;color:var(--red);margin-bottom:8px">GAME OVER</div>
  <div class="rank-letter" id="go-rank"></div>
  <div class="final-score" id="go-score"></div>
  <div id="go-record" style="display:none" class="new-record">‚òÖ NEW RECORD! ‚òÖ</div>
  <div class="stats-grid" id="go-stats"></div>
  <div style="display:flex;gap:12px;margin-top:8px">
    <button class="btn btn-danger" onclick="Game.start()">RETRY</button>
    <button class="btn btn-secondary" onclick="Game.showTitle()">HOME</button>
  </div>
</div>

<!-- VICTORY SCREEN -->
<div class="screen" id="victory-screen">
  <div style="font-size:24px;font-weight:700;color:var(--gold);margin-bottom:4px">üèÜ VICTORY üèÜ</div>
  <div class="rank-letter" id="vic-rank"></div>
  <div class="final-score" id="vic-score"></div>
  <div id="vic-record" style="display:none" class="new-record">‚òÖ NEW RECORD! ‚òÖ</div>
  <div class="stats-grid" id="vic-stats"></div>
  <div style="display:flex;gap:12px;margin-top:8px">
    <button class="btn btn-primary" onclick="Game.start()">PLAY AGAIN</button>
    <button class="btn btn-secondary" onclick="Game.showTitle()">HOME</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SNAPSHOT ‚Äî REACTION GAME ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LEVELS = [
  { num:1, name:"Warm Up", mechanic:"Static Targets", desc:"Click the green targets before they disappear. Easy start!", targetCount:8, window:2000, size:60, moving:false, decoys:0, shrinking:false, ghost:false, chain:false, boss:false },
  { num:2, name:"Quick Draw", mechanic:"Faster Pace", desc:"Targets appear and vanish quicker. Stay alert!", targetCount:10, window:1500, size:50, moving:false, decoys:0, shrinking:false, ghost:false, chain:false, boss:false },
  { num:3, name:"Sharpshooter", mechanic:"Small Targets", desc:"Smaller targets test your precision. Aim carefully!", targetCount:12, window:1500, size:32, moving:false, decoys:0, shrinking:false, ghost:false, chain:false, boss:false },
  { num:4, name:"Moving Targets", mechanic:"Targets Move", desc:"Targets drift across the screen. Track and click!", targetCount:10, window:2000, size:46, moving:true, decoys:0, shrinking:false, ghost:false, chain:false, boss:false },
  { num:5, name:"Friend or Foe", mechanic:"Decoys Added", desc:"Green = click. RED = don't click! Decoys drain your health.", targetCount:12, window:1500, size:44, moving:false, decoys:6, shrinking:false, ghost:false, chain:false, boss:false },
  { num:6, name:"Shrinking", mechanic:"Shrinking Targets", desc:"Targets shrink from large to nothing. Click before they vanish!", targetCount:14, window:3000, size:70, moving:false, decoys:0, shrinking:true, ghost:false, chain:false, boss:false },
  { num:7, name:"Chaos", mechanic:"Moving + Decoys", desc:"Moving targets AND decoys. Pure chaos. Stay focused!", targetCount:12, window:1200, size:42, moving:true, decoys:8, shrinking:false, ghost:false, chain:false, boss:false },
  { num:8, name:"Ghost", mechanic:"Invisible Targets", desc:"Targets flash briefly then vanish. Click where they were!", targetCount:10, window:1800, size:50, moving:false, decoys:0, shrinking:false, ghost:true, chain:false, boss:false },
  { num:9, name:"Chain Reaction", mechanic:"Click in Order", desc:"Numbered targets appear. Click 1‚Üí2‚Üí3‚Üí4‚Üí5 in order!", targetCount:15, window:8000, size:40, moving:false, decoys:0, shrinking:false, ghost:false, chain:true, boss:false },
  { num:10, name:"Boss Round", mechanic:"Everything!", desc:"All mechanics combined. Survive the onslaught!", targetCount:20, window:1000, size:40, moving:true, decoys:10, shrinking:false, ghost:false, chain:false, boss:true },
];

const Game = {
  screen: 'title', levelIdx: 0, score: 0, health: 100,
  combo: 0, maxCombo: 0, totalHits: 0, totalMisses: 0, totalShots: 0,
  reactionTimes: [], levelHits: 0, levelMisses: 0, levelCombo: 0,
  targets: [], activeTargets: [], spawnIdx: 0, spawnTimer: null,
  levelStartTime: 0, animFrame: null, isPlaying: false,

  // ‚îÄ‚îÄ Screen Management ‚îÄ‚îÄ
  showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    const hud = document.getElementById('hud');
    const combo = document.getElementById('combo-display');
    if (id === 'game-screen') { hud.style.display = 'block'; combo.style.display = 'block'; }
    else { hud.style.display = 'none'; combo.style.display = 'none'; }
  },

  showTitle() {
    this.showScreen('title-screen');
    const pb = localStorage.getItem('snapshot_pb');
    document.getElementById('pb-value').textContent = pb ? pb.toLocaleString() : '‚Äî';
  },

  // ‚îÄ‚îÄ Start Game ‚îÄ‚îÄ
  start() {
    this.levelIdx = 0; this.score = 0; this.health = 100;
    this.combo = 0; this.maxCombo = 0; this.totalHits = 0;
    this.totalMisses = 0; this.totalShots = 0; this.reactionTimes = [];
    this.showIntro();
  },

  // ‚îÄ‚îÄ Level Intro ‚îÄ‚îÄ
  showIntro() {
    const lv = LEVELS[this.levelIdx];
    document.getElementById('intro-num').textContent = lv.num;
    document.getElementById('intro-mechanic').textContent = '‚ö° ' + lv.mechanic;
    document.getElementById('intro-name').textContent = lv.name;
    document.getElementById('intro-desc').textContent = lv.desc;
    this.showScreen('intro-screen');
  },

  // ‚îÄ‚îÄ Start Level ‚îÄ‚îÄ
  startLevel() {
    const lv = LEVELS[this.levelIdx];
    this.levelHits = 0; this.levelMisses = 0; this.levelCombo = 0;
    this.spawnIdx = 0; this.activeTargets = []; this.isPlaying = true;
    this.levelStartTime = Date.now();
    this.showScreen('game-screen');
    this.updateHUD();
    this.updateHealth();
    this.updateComboDisplay();

    const area = document.getElementById('game-area');
    // Scope cursor from Sharpshooter (level 3) onward
    if (lv.num >= 3) area.classList.add('scope-cursor');
    else area.classList.remove('scope-cursor');
    // Clear old targets
    area.querySelectorAll('.target,.hit-burst,.miss-x,.score-popup,.particle,.flash').forEach(e => e.remove());
    document.getElementById('progress-bar').style.width = '0%';

    // Misclick handler
    area.onclick = (e) => {
      if (!this.isPlaying) return;
      if (e.target === area || e.target.classList.contains('progress-wrap') || e.target.classList.contains('progress-bar')) {
        this.onMisclick();
      }
    };

    // Small delay to ensure game area is rendered and has dimensions
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        if (lv.chain) { this.startChain(0); }
        else { this.scheduleSpawn(); }
      });
    });
  },

  // ‚îÄ‚îÄ Spawn Logic ‚îÄ‚îÄ
  scheduleSpawn() {
    const lv = LEVELS[this.levelIdx];
    const total = lv.targetCount + lv.decoys;
    if (this.spawnIdx >= total) { this.checkLevelDone(); return; }
    if (!this.isPlaying) return;

    // Determine spawn delay
    const delay = lv.boss ? 300 + Math.random() * 500 : 400 + Math.random() * 600;

    this.spawnTimer = setTimeout(() => {
      if (!this.isPlaying) return;
      const isDecoy = lv.decoys > 0 && this.spawnIdx >= lv.targetCount;
      this.spawnTarget(isDecoy, lv);
      this.spawnIdx++;
      this.updateProgress();
      this.scheduleSpawn();
    }, this.spawnIdx === 0 ? 500 : delay);
  },

  spawnTarget(isDecoy, lv) {
    const area = document.getElementById('game-area');
    const rect = area.getBoundingClientRect();
    const size = isDecoy ? lv.size : (lv.boss ? lv.size + Math.random()*20-10 : lv.size);
    const margin = 10;
    const x = margin + Math.random() * (rect.width - size - margin*2);
    const y = margin + Math.random() * (rect.height - size - margin*2 - 4);

    const el = document.createElement('div');
    el.className = 'target ' + (isDecoy ? 'decoy' : 'good');
    el.style.width = size + 'px'; el.style.height = size + 'px';
    el.style.left = x + 'px'; el.style.top = y + 'px';

    const spawnTime = Date.now();
    let vx = 0, vy = 0;

    // Moving
    if (lv.moving && !isDecoy) {
      vx = (Math.random() - 0.5) * 2; vy = (Math.random() - 0.5) * 2;
      el.classList.add('moving');
    }
    if (lv.boss && Math.random() < 0.4) {
      vx = (Math.random() - 0.5) * 2.5; vy = (Math.random() - 0.5) * 2.5;
      el.classList.add('moving');
    }

    // Ghost
    let isGhost = lv.ghost || (lv.boss && Math.random() < 0.2);
    if (isDecoy) isGhost = false;

    if (isGhost) {
      el.style.opacity = '1'; el.style.transition = 'opacity 0.3s';
      setTimeout(() => { if (el.parentNode) { el.style.opacity = '0'; el.classList.add('ghost'); } }, 500);
      setTimeout(() => { if (el.parentNode) { el.classList.add('ghost-hint'); el.style.opacity = '1'; } }, 600);
    }

    // Shrinking
    let isShrinking = lv.shrinking || (lv.boss && Math.random() < 0.3);
    if (isDecoy) isShrinking = false;
    if (isShrinking) {
      el.style.transition = 'width ' + (lv.window/1000) + 's linear, height ' + (lv.window/1000) + 's linear, opacity 0.3s';
      setTimeout(() => {
        el.style.width = '0px'; el.style.height = '0px';
        el.style.left = (x + size/2) + 'px'; el.style.top = (y + size/2) + 'px';
      }, 200);
    }

    // Click handler
    el.onclick = (e) => {
      e.stopPropagation();
      if (!this.isPlaying) return;
      if (isDecoy) { this.onDecoyClick(el); return; }
      const rt = Date.now() - spawnTime;
      this.onHit(el, rt, x + size/2, y + size/2);
    };

    area.appendChild(el);

    // Timeout ‚Äî miss
    const timeout = setTimeout(() => {
      if (el.parentNode && !isDecoy) { this.onMiss(el, x + size/2, y + size/2); }
      else if (el.parentNode && isDecoy) { el.remove(); } // decoy timeout is fine
    }, lv.window);

    // Store for moving
    const tgt = { el, vx, vy, x, y, size, timeout, isDecoy };
    this.activeTargets.push(tgt);

    // Start movement
    if (vx || vy) this.startMovement(tgt, area);
  },

  startMovement(tgt, area) {
    const rect = area.getBoundingClientRect();
    const baseX = tgt.x, baseY = tgt.y;
    let lastTime = performance.now();
    // Set initial position via left/top, then move via transform for GPU acceleration
    tgt.el.style.left = baseX + 'px';
    tgt.el.style.top = baseY + 'px';
    let offX = 0, offY = 0;
    function move(now) {
      if (!tgt.el.parentNode) return;
      const dt = Math.min(now - lastTime, 32) / 16; // normalize to ~60fps, cap to avoid jumps
      lastTime = now;
      offX += tgt.vx * dt; offY += tgt.vy * dt;
      const curX = baseX + offX, curY = baseY + offY;
      if (curX < 0 || curX > rect.width - tgt.size) { tgt.vx *= -1; offX += tgt.vx * dt * 2; }
      if (curY < 0 || curY > rect.height - tgt.size - 4) { tgt.vy *= -1; offY += tgt.vy * dt * 2; }
      tgt.el.style.transform = 'translate(' + offX.toFixed(1) + 'px,' + offY.toFixed(1) + 'px)';
      // Update tgt.x/y for hit detection
      tgt.x = baseX + offX; tgt.y = baseY + offY;
      requestAnimationFrame(move);
    }
    requestAnimationFrame(move);
  },

  // ‚îÄ‚îÄ Chain Level ‚îÄ‚îÄ
  startChain(chainNum) {
    if (chainNum >= 3) { this.checkLevelDone(); return; }
    if (!this.isPlaying) return;
    const lv = LEVELS[this.levelIdx];
    const area = document.getElementById('game-area');
    area.querySelectorAll('.target').forEach(e => e.remove());
    const rect = area.getBoundingClientRect();
    let chainIdx = 0;
    const targets = [];
    const spawnTime = Date.now();

    for (let i = 0; i < 5; i++) {
      const size = lv.size;
      const x = 20 + Math.random() * (rect.width - size - 40);
      const y = 20 + Math.random() * (rect.height - size - 40);
      const el = document.createElement('div');
      el.className = 'target good';
      el.style.width = size + 'px'; el.style.height = size + 'px';
      el.style.left = x + 'px'; el.style.top = y + 'px';
      el.textContent = (i+1);
      el.style.animationDelay = (i * 0.08) + 's';

      el.onclick = (e) => {
        e.stopPropagation();
        if (!this.isPlaying) return;
        if (i === chainIdx) {
          const rt = Date.now() - spawnTime;
          this.onHit(el, rt, x + size/2, y + size/2);
          chainIdx++;
          if (chainIdx >= 5) {
            this.spawnIdx += 5;
            this.updateProgress();
            setTimeout(() => this.startChain(chainNum + 1), 600);
          }
        } else {
          this.onChainMiss(el, x + size/2, y + size/2);
        }
      };
      area.appendChild(el);
      targets.push(el);
    }

    // Chain timeout
    setTimeout(() => {
      if (!this.isPlaying) return;
      targets.forEach(el => { if (el.parentNode) { this.totalMisses++; this.levelMisses++; el.remove(); } });
      this.damageHealth(8);
      this.spawnIdx += 5;
      this.updateProgress();
      this.startChain(chainNum + 1);
    }, lv.window);
  },

  // ‚îÄ‚îÄ Hit ‚îÄ‚îÄ
  onHit(el, reactionTime, cx, cy) {
    clearTimeout(this.activeTargets.find(t => t.el === el)?.timeout);
    el.remove();
    this.totalHits++; this.levelHits++; this.totalShots++;
    this.reactionTimes.push(reactionTime);
    this.combo++; if (this.combo > this.maxCombo) this.maxCombo = this.combo;
    if (this.combo > this.levelCombo) this.levelCombo = this.combo;

    // Precision scoring
    let tier, base, color;
    if (reactionTime < 200) { tier = 'PERFECT!'; base = 100; color = 'var(--gold)'; }
    else if (reactionTime < 400) { tier = 'GREAT!'; base = 75; color = 'var(--accent-light)'; }
    else if (reactionTime < 700) { tier = 'GOOD!'; base = 50; color = 'var(--green)'; }
    else if (reactionTime < 1000) { tier = 'OK'; base = 25; color = 'var(--ink)'; }
    else { tier = 'SLOW'; base = 10; color = 'var(--muted)'; }

    const pts = base * Math.min(this.combo, 10);
    this.score += pts;

    // Effects
    this.showBurst(cx, cy); this.showParticles(cx, cy, 'var(--green)');
    this.showPopup(cx, cy, `${tier} +${pts}`, color);
    this.showFlash('green');
    this.updateComboDisplay();
    this.updateHUD();
  },

  // ‚îÄ‚îÄ Miss ‚îÄ‚îÄ
  onMiss(el, cx, cy) {
    el.remove();
    this.totalMisses++; this.levelMisses++; this.totalShots++;
    this.breakCombo();
    this.damageHealth(8);
    this.showMissX(cx, cy); this.showFlash('red');
    const lv = LEVELS[this.levelIdx];
    if (lv.boss) document.getElementById('game-area').classList.add('shake');
    setTimeout(() => document.getElementById('game-area').classList.remove('shake'), 300);
    this.updateHUD();
  },

  onDecoyClick(el) {
    el.remove();
    this.totalMisses++; this.levelMisses++; this.totalShots++;
    const rect = el.getBoundingClientRect();
    const area = document.getElementById('game-area').getBoundingClientRect();
    const cx = rect.left - area.left + rect.width/2;
    const cy = rect.top - area.top + rect.height/2;
    this.breakCombo();
    this.damageHealth(15);
    this.showParticles(cx, cy, 'var(--red)');
    this.showPopup(cx, cy, '‚úó DECOY! -15%', 'var(--red)');
    this.showFlash('red');
    if (LEVELS[this.levelIdx].boss) document.getElementById('game-area').classList.add('shake');
    setTimeout(() => document.getElementById('game-area').classList.remove('shake'), 300);
    this.updateHUD();
  },

  onMisclick() {
    this.breakCombo();
    this.damageHealth(5);
    this.showFlash('red');
    this.updateHUD();
  },

  onChainMiss(el, cx, cy) {
    this.totalMisses++; this.levelMisses++;
    this.breakCombo();
    this.damageHealth(8);
    this.showMissX(cx, cy); this.showFlash('red');
    this.updateHUD();
  },

  // ‚îÄ‚îÄ Health ‚îÄ‚îÄ
  damageHealth(amt) {
    this.health = Math.max(0, this.health - amt);
    this.updateHealth();
    if (this.health <= 0) { this.gameOver(); }
  },

  updateHealth() {
    const bar = document.getElementById('health-bar');
    const text = document.getElementById('health-text');
    bar.style.width = this.health + '%';
    text.textContent = Math.round(this.health) + '%';
    if (this.health > 60) bar.style.backgroundColor = 'var(--green)';
    else if (this.health > 30) bar.style.backgroundColor = 'var(--yellow)';
    else bar.style.backgroundColor = 'var(--red)';
  },

  // ‚îÄ‚îÄ Combo ‚îÄ‚îÄ
  breakCombo() {
    if (this.combo > 1) {
      const cb = document.getElementById('combo-broken');
      cb.classList.remove('show');
      void cb.offsetWidth;
      cb.classList.add('show');
    }
    this.combo = 0;
    this.updateComboDisplay();
  },

  updateComboDisplay() {
    const el = document.getElementById('combo-display');
    const mult = Math.min(this.combo, 10);
    if (mult > 1) {
      el.textContent = 'x' + mult;
      el.classList.add('active');
      el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse');
      el.style.color = mult >= 8 ? 'var(--gold)' : mult >= 5 ? 'var(--green)' : 'var(--accent-light)';
    } else {
      el.classList.remove('active');
    }
  },

  // ‚îÄ‚îÄ HUD ‚îÄ‚îÄ
  updateHUD() {
    document.getElementById('hud-level').innerHTML = 'Level: <span>' + LEVELS[this.levelIdx].num + '</span>';
    document.getElementById('hud-score').textContent = this.score.toLocaleString();
    const total = this.totalHits + this.totalMisses;
    const acc = total > 0 ? Math.round(this.totalHits / total * 100) : 100;
    document.getElementById('hud-acc').textContent = acc + '%';
  },

  updateProgress() {
    const lv = LEVELS[this.levelIdx];
    const total = lv.targetCount + lv.decoys;
    const pct = Math.min(100, (this.spawnIdx / total) * 100);
    document.getElementById('progress-bar').style.width = pct + '%';
  },

  // ‚îÄ‚îÄ Effects ‚îÄ‚îÄ
  showBurst(cx, cy) {
    const area = document.getElementById('game-area');
    const b = document.createElement('div');
    b.className = 'hit-burst';
    b.style.left = (cx - 20) + 'px'; b.style.top = (cy - 20) + 'px';
    b.style.width = '40px'; b.style.height = '40px';
    area.appendChild(b);
    setTimeout(() => b.remove(), 400);
  },

  showParticles(cx, cy, color) {
    const area = document.getElementById('game-area');
    for (let i = 0; i < 6; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.left = cx + 'px'; p.style.top = cy + 'px';
      p.style.background = color;
      const angle = (Math.PI * 2 / 6) * i;
      const dist = 30 + Math.random() * 30;
      const tx = Math.cos(angle) * dist;
      const ty = Math.sin(angle) * dist;
      p.style.transition = 'transform 0.4s ease, opacity 0.4s ease';
      area.appendChild(p);
      requestAnimationFrame(() => {
        p.style.transform = `translate(${tx}px, ${ty}px)`;
        p.style.opacity = '0';
      });
      setTimeout(() => p.remove(), 400);
    }
  },

  showPopup(cx, cy, text, color) {
    const area = document.getElementById('game-area');
    const p = document.createElement('div');
    p.className = 'score-popup';
    p.textContent = text;
    p.style.color = color;
    p.style.left = cx + 'px'; p.style.top = (cy - 20) + 'px';
    area.appendChild(p);
    setTimeout(() => p.remove(), 800);
  },

  showMissX(cx, cy) {
    const area = document.getElementById('game-area');
    const x = document.createElement('div');
    x.className = 'miss-x';
    x.textContent = '‚úó';
    x.style.left = (cx - 16) + 'px'; x.style.top = (cy - 16) + 'px';
    area.appendChild(x);
    setTimeout(() => x.remove(), 600);
  },

  showFlash(type) {
    const area = document.getElementById('game-area');
    const f = document.createElement('div');
    f.className = 'flash ' + type;
    area.appendChild(f);
    setTimeout(() => f.remove(), 200);
  },

  // ‚îÄ‚îÄ Level Done ‚îÄ‚îÄ
  checkLevelDone() {
    if (!this.isPlaying) return;
    // Wait for all active targets to resolve
    setTimeout(() => {
      if (!this.isPlaying) return;
      this.isPlaying = false;
      clearTimeout(this.spawnTimer);

      // Regen health
      this.health = Math.min(100, this.health + 10);
      this.updateHealth();

      // Stars
      const total = this.levelHits + this.levelMisses;
      const acc = total > 0 ? this.levelHits / total : 1;
      let stars = '‚òÖ';
      if (acc >= 0.7) stars = '‚òÖ‚òÖ';
      if (acc >= 0.9) stars = '‚òÖ‚òÖ‚òÖ';

      const elapsed = ((Date.now() - this.levelStartTime) / 1000).toFixed(1);

      document.getElementById('comp-title').textContent = '‚úì ' + LEVELS[this.levelIdx].name + ' Complete!';
      document.getElementById('comp-stars').textContent = stars;
      document.getElementById('comp-stats').innerHTML = `
        <div class="stat-item"><div class="stat-label">Hits</div><div class="stat-value" style="color:var(--green)">${this.levelHits}</div></div>
        <div class="stat-item"><div class="stat-label">Misses</div><div class="stat-value" style="color:var(--red)">${this.levelMisses}</div></div>
        <div class="stat-item"><div class="stat-label">Accuracy</div><div class="stat-value">${Math.round(acc*100)}%</div></div>
        <div class="stat-item"><div class="stat-label">Best Combo</div><div class="stat-value" style="color:var(--accent-light)">x${this.levelCombo}</div></div>
        <div class="stat-item"><div class="stat-label">Time</div><div class="stat-value">${elapsed}s</div></div>
        <div class="stat-item"><div class="stat-label">Health</div><div class="stat-value">${Math.round(this.health)}%</div></div>
      `;

      // Check if last level
      if (this.levelIdx >= LEVELS.length - 1) {
        this.victory();
        return;
      }

      this.showScreen('complete-screen');
    }, 1500);
  },

  nextLevel() {
    this.levelIdx++;
    this.showIntro();
  },

  // ‚îÄ‚îÄ Game Over ‚îÄ‚îÄ
  gameOver() {
    this.isPlaying = false;
    clearTimeout(this.spawnTimer);
    document.getElementById('game-area').querySelectorAll('.target').forEach(e => e.remove());

    const rank = this.getRank();
    document.getElementById('go-rank').textContent = rank.letter;
    document.getElementById('go-rank').className = 'rank-letter rank-' + rank.letter.toLowerCase();

    const isRecord = this.checkRecord();
    document.getElementById('go-record').style.display = isRecord ? 'block' : 'none';

    this.animateScore('go-score', this.score);
    this.showFinalStats('go-stats');
    this.showScreen('gameover-screen');
  },

  // ‚îÄ‚îÄ Victory ‚îÄ‚îÄ
  victory() {
    const rank = this.getRank();
    document.getElementById('vic-rank').textContent = rank.letter;
    document.getElementById('vic-rank').className = 'rank-letter rank-' + rank.letter.toLowerCase();

    const isRecord = this.checkRecord();
    document.getElementById('vic-record').style.display = isRecord ? 'block' : 'none';

    this.animateScore('vic-score', this.score);
    this.showFinalStats('vic-stats');
    this.showScreen('victory-screen');
  },

  getRank() {
    if (this.score > 15000) return { letter: 'S' };
    if (this.score > 10000) return { letter: 'A' };
    if (this.score > 7000) return { letter: 'B' };
    if (this.score > 4000) return { letter: 'C' };
    if (this.score > 2000) return { letter: 'D' };
    return { letter: 'F' };
  },

  checkRecord() {
    const pb = parseInt(localStorage.getItem('snapshot_pb')) || 0;
    if (this.score > pb) { localStorage.setItem('snapshot_pb', this.score); return true; }
    return false;
  },

  animateScore(elId, target) {
    const el = document.getElementById(elId);
    let current = 0;
    const step = Math.max(1, Math.floor(target / 60));
    const interval = setInterval(() => {
      current += step;
      if (current >= target) { current = target; clearInterval(interval); }
      el.textContent = current.toLocaleString();
    }, 16);
  },

  showFinalStats(elId) {
    const total = this.totalHits + this.totalMisses;
    const acc = total > 0 ? Math.round(this.totalHits / total * 100) : 0;
    const avgRT = this.reactionTimes.length > 0 ? Math.round(this.reactionTimes.reduce((a,b)=>a+b,0) / this.reactionTimes.length) : 0;
    document.getElementById(elId).innerHTML = `
      <div class="stat-item"><div class="stat-label">Accuracy</div><div class="stat-value">${acc}%</div></div>
      <div class="stat-item"><div class="stat-label">Best Combo</div><div class="stat-value" style="color:var(--gold)">x${this.maxCombo}</div></div>
      <div class="stat-item"><div class="stat-label">Avg Reaction</div><div class="stat-value">${avgRT}ms</div></div>
      <div class="stat-item"><div class="stat-label">Levels</div><div class="stat-value">${this.levelIdx + 1}/${LEVELS.length}</div></div>
      <div class="stat-item"><div class="stat-label">Targets Hit</div><div class="stat-value" style="color:var(--green)">${this.totalHits}</div></div>
      <div class="stat-item"><div class="stat-label">Total Score</div><div class="stat-value" style="color:var(--accent-light)">${this.score.toLocaleString()}</div></div>
    `;
  },
};

// Init
Game.showTitle();
</script>
<script src="../shared/recommendations.js" defer></script>
</body>
</html>
